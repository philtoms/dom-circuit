const t=Symbol("_REDUCERS"),n=Symbol("_BASE"),e=Symbol("_PROPAGATE"),o=(e={},[s,...i])=>"."===s?o(e,i):".."===s?o(e[n],i):s?i.length?o(e[s],i):[e[t],e[s]]:e[n]?o(e[n],[s,...i]):o(e,i),s=globalThis.document,i=(t,n)=>{const e=[(/[#\.]/.test(n[0])?[""]:[".","#",""]).reduce((e,o)=>e.length?e:t.querySelectorAll(o+n),[])].find(t=>t.length)||s.querySelectorAll(n);return e.length?e:[t]},r=(c,a={})=>{const{t:u,o:d,parent:f={id:"",state:()=>m},s:l=[],i:b=[],u:y={},mount:g=[s]}=a;let{l:j,state:m={}}=a;"function"==typeof a&&(j=a);const p=(t,n,e,o,s)=>{if(t instanceof Promise)return t.then(t=>p(t,n,!1,o,s)),m;if(t===m||"object"==typeof t&&n in t&&t[n]===m[n])return t;const i=e!==b;s?m=b.reduce((e,[,o,s])=>!s&&o(t[n],b,e)||e,m):(m=t,i&&(m=b.reduce((t,[e,s,i])=>i&&e&&o.startsWith(e)?(s(void 0===t[n]?t:t[n],b),m):!e&&s(void 0,b,t)||t,m)));const r=!e&&b.find(([t,,,e])=>t===n&&e);return j&&i&&j(m,o,!!n,!!r||e),r&&r[1](void 0,!0,m),m},S=(s,[c,a,u])=>{const[,,S,,v,_]=c.match(/(([\w]+):)?(\s*([^_]+))?(_)?/),[E,O=""]=v.split("$"),P=/^[\/\.]/.test(O),$="function"!=typeof a,x=$&&Object.keys(a).some(t=>!t.startsWith("$"));if(u){const[t]=o(s,u.split("/"));return t.push([u.replace(/\./g,""),a,b]),s}const A=[].concat(g).reduce((t,n)=>[...t,...n&&E?i(n,E):[n]],[]),R=E.replace(/[#\.\-\[\]\(\)\"\=\^\&]/g,""),h=(R||O?`${f.id}/${R||O}`:f.id||"/").replace("//","/");R&&"object"==typeof m&&!(R in m)&&(m[R]=$?{}:void 0);const w=$?r(a,{l:(t,n,e,o)=>m=p(e?{...m,[R]:t}:t,R,o,n),t:s,o:d,state:m[R]||m,mount:A,parent:{id:h,address:R,state:()=>m},s:l}):{},T={id:h,address:R,signal:(t,n)=>o(t.startsWith("//")&&d||s,t.split("/"))[1](n),el:A.length<=1?A[0]:A},B=new Proxy(T,{get:(t,n)=>n in y?y[n]:T[n],set:(t,n,e)=>(y[n]=e,!0)});if("init"===O){const t=a.call(B,R?m:f.state());if(!R)return void 0!==t&&(m=t,j&&j(m,h)),s;t&&(m[R]=t[R])}const C=function(t,n,o=(R?m:f.state())){const s=R||f.address;return void 0===t&&(t=o[s]),($?w[e]:p)($?{...o,[s]:t}:A.reduce((n,e)=>(T.el=e,_?{...n,[s]:a.call(B,t)||n[s]}:a.call(B,n,t)||n),o),$&&!x?"":R,n,h,x)};if(!P&&!O||"state"===O){b.push([R,C]);const[t,n]=o(d,h.split("/"));"function"==typeof n&&(b.push([R,n,t,!0]),t.push([R,C,b,!0]))}return P&&l.push([c,C,O]),Object.entries(w).forEach(([t,n])=>C[t]=n),C[t]=w[t],C[n]=w[n],"state"!==O&&(s[S||R||O]=C),O&&!P&&"state"!==O&&A.forEach(t=>t&&t.addEventListener(O,C)),s},v=Object.entries(c).reduce(S,{[t]:b,[n]:u,[e]:p,get state(){return m},g:(t,n)=>r(t,{...n,o:v})});return f.id?v:l.reduce(S,v)};export default r;