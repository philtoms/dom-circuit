const t=Symbol("_REDUCERS"),e=Symbol("_BASE"),n=Symbol("_PROPAGATE"),s=(n={},[o,...r])=>"."===o?s(n,r):".."===o?s(n[e],r):o?r.length?s(n[o],r):[n[t],n[o]]:n[e]?s(n[e],[o,...r]):s(n,r),o=globalThis.document,r=(t,e)=>{const n=[(/[#\.]/.test(e[0])?[""]:[".","#",""]).reduce((n,s)=>n.length?n:t.querySelectorAll(s+e),[])].find(t=>t.length)||o.querySelectorAll(e);return n.length?n:[t]},i=(a,c={})=>{const{t:d,s:u,parent:f={id:"",state:()=>y},o:l=[],i:b=[],u:g={},l:m,mount:v=[o]}=c;let{state:y={}}=c;const S=(t,e,n,s,o)=>{if(t instanceof Promise)return t.then(t=>S(t,!1,n,s,o)),y;if(t===y)return y;void 0===t&&(t=y);const r=e!==b;o?y=b.reduce((e,[,o,r])=>!r&&o(t[n],b,s,e)||e,y):(y=t,r&&(y=b.reduce((t,[o,r,i])=>i&&o&&s.startsWith(o)?(r(void 0===t[n]?t:t[n],b,s),y):!o&&"state"!==e&&r(void 0,b,s,t)||t,y)));const i=!e&&b.find(([t,,,e])=>t===n&&e);return m&&r&&m(y,s,!!i||e,!!n),i&&i[1](void 0,!0,s,y),y},j=(o,[a,c,d])=>{const[,,j,,p,_]=a.match(/(([\w]+):)?(\s*([^_]+))?(_)?/),[E,O=""]=p.split("$"),P=/^[\/\.]/.test(O),$="function"!=typeof c&&c,x=$&&Object.keys($).some(t=>!t.startsWith("$"));if(d){const[t]=s(o,d.split("/"));return t.push([d.replace(/\./g,""),c,b]),o}const A=[].concat(v).reduce((t,e)=>[...t,...e&&E?r(e,E):[e]],[]),R=E.replace(/[#\.\-\[\]\(\)\"\=\^\&]/g,""),h=R||O?`${f.id}/${R||O}`:f.id||"/",w={id:h,address:R,signal:(t,e)=>s(t.startsWith("//")&&u||o,t.split("/"))[1](e),el:A.length<=1?A[0]:A},C=new Proxy(w,{get:(t,e)=>e in g?g[e]:w[e],set:(t,e,n)=>(g[e]=n,!0)}),T=$?i($,{l:(t,e,n,s)=>S(s?{...y,[R]:t}:t,n,R,e||h),t:o,s:u,state:y[R]||y,parent:{id:h,address:R,state:()=>y,g:x},o:l,mount:A}):{};if("init"===O){const t=c.call(C,R?y:f.state());if(!R)return void 0!==t&&(y=t,m&&m(y,h,"state")),o;t&&(y[R]=t[R])}const B=function(t,e,s,o=(R?y:f.state())){const r=R||f.address;return void 0===t&&(t=o[r]),($?T[n]:S)($?{...o,[r]:t}:A.reduce((e,n)=>(w.el=n,_?((t,e)=>{const n=c.call(C,e);return void 0===n?void 0:n===e?y:{...y,[t]:n}})(r,t):c.call(C,e,t)),o),e,$&&!x?"":R,s||h,x||!R&&f.g&&"state"!==O)};if(!P&&!O||"state"===O){b.push([R,B]);const[t,e]=s(u,h.split("/"));"function"==typeof e&&(b.push([R,e,t,!0]),t.push([R,B,b,!0]))}return P&&l.push([a,B,O]),Object.entries(T).forEach(([t,e])=>B[t]=e),B[t]=T[t],B[e]=T[e],"state"!==O&&(o[j||R||O]=B),O&&!P&&"state"!==O&&A.forEach(t=>t&&t.addEventListener(O,B)),o},p=Object.entries(a).reduce(j,{[t]:b,[e]:d,[n]:S,get state(){return y},m:(t,e)=>i(t,{...e,s:p})});return f.id?p:l.reduce(j,p)};export default i;